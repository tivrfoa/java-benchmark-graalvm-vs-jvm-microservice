The initial goal of this repo was to compare GraalVM vs JVM for
a simple microservice, regarding: startup time, cpu, rss and performance.

I then also added Go to the mix.


  - [Why do that?](#why-do-that)
  - [Why compare against Go?](#why-compare-against-go)
  - [Running the Benchmark](#running-the-benchmark)
  - [Results](#results)

## Why do that?

I'm mostly a Java developer, but Java uses too much memory compared to
some other languages.<br>
For many kinds of applications this is not a problem, and memory is
cheap nowadays (???), but if you have thousands of microservices,
the cost can become significant.

Of course, that is not the only cost you should consider. Probably
Go and Rust developers are more expensive than Java ones,
which could make the memory cost irrelevant.

They say every benchmark is flawed =), so please open an issue or PR
if you find something wrong.

I'm not a Go developer, so most of the Go code was generated by Gemini.<br>
Gemini did a great job, I guess. =)<br>

## Why compare against Go?

Two things that I'm really impressed about Go:
  - Fast compilation time;
  - Low memory usage (even with a GC).

## What does this application do?

The app consists of only two endpoints:
  - /hello
  - /db

### /hello

It returns a JSON with client's phones, address and loan options.<br>
It contains an unreachable branch: all clients are at least 18 years old.
The goal here is to check if Java JIT can take advantage of that.

  - getClient: returns one client from 10 clients;
  - getPhones: calls a REST API to get client's phones;
  - getAddress: calls a REST API to get client's address;
  - calculateLoanOptions: returns loan options based on customer's salary.

### /db

- queryMovies: query movies from a Postgres table;
- getClientFavoriteDirectorMovies: get all movies directed by client's favorite director.


## Running the Benchmark

- Create Java jar files: go to each Java program and run: `mvn clean package`
- Build client api: `make buildApi`
- Build Go app: `make buildGo`
- Start Postgress database: `docker-compose up`
- Start client api: `make api`
- Run app (test one at a time, they use the same port):
  - Go: `make goService`
  - Java: `make javaQuarkus`

In the [Makefile](Makefile) there are options to use `k6`, `vegeta` and `wrk`.


## Results

```
Ubuntu 22.04.4 LTS
6.8.0-40-generic #40~22.04.3-Ubuntu SMP PREEMPT_DYNAMIC Tue Jul 30 17:30:19 UTC 2 x86_64 x86_64 x86_64 GNU/Linux

Lenovo IdeaPad S145-15API
8,0 GiB
AMD® Ryzen 5 3500u with radeon vega mobile gfx × 8
AMD® Radeon vega 8 graphics
```

You can check more results for [here](perf-stat-java-native-vs-jvm.md).

Unscientifically checking max cpu % and rss by just looking at System Monitor ...

### make wrkJSON

`wrk -L -t 10 -d 20 -c 100 -R 2000 http://localhost:8081/hello`

|| command | startup | max cpu% | max rss (MB) | Req/sec | Avg | Max |
|---|---|---|---|---|---|---|---|
|JVM First Run | make javaQuarkus| 1.369s | 86.65% | 330 | 1971.75 | 1.32s | 2.55s |
|JVM Second Run | - | - | 74% | 333 | 1990.03 | 3.29ms | 23.70ms |
|JVM Third Run | - | - | 43% | 315 | 1989.72 | 2.56ms | 17.09ms |
|JVM Fourth Run | - | - | 31% | 315 | 2000.28 | 1.81ms | 10.64ms |
|GraalVM| make graalvm | 0.025s| 26.67% | 111 | 2000.15 | 2.03ms | 20.93ms |
|Go| make goService | 0.016s | 21.3% | 19.1 | 2000.21 | 2.05ms | 15.77ms |
|Vertx First Run| make vertx | ? | 32% | 225 | 2000.32 | 211.68ms | 1.45s |
|Vertx Second Run| - | - | 21% | 217 | 2000.29 | 1.59ms | 6.29ms |
|Vertx Third Run¹| - | - | 8.64% | 217 | 2000.09 | 3.89ms | 14.86ms |
|Vertx Fourth Run| - | - | 11.6% | 203 | 2000.28 | 1.37ms | 5.05ms |

¹ I don't know why it ran slower. Maybe GC

Latency Distribution - Best of 5 runs:

||50%|75%|90%|99%|99.9%|99.99%|99.999%|
|---|---|---|---|---|---|---|---|
|JVM Vertx|1.45ms|2.00ms|3.44ms|5.97ms|7.99ms|9.45ms|9.80ms|9.80ms|
|JVM Quarkus|1.84ms|2.18ms|2.55ms|3.69ms|5.49ms|6.23ms|6.74ms|6.74ms|
|GraalVM Quarkus|1.96ms|2.27ms|2.65ms|3.83ms|13.53ms|16.20ms|17.06ms|
|Go|1.53ms|1.92ms|2.50ms|4.17ms|5.11ms|5.57ms|7.94ms|7.94ms|

### make wrkDB

`wrk -L -t 10 -d 20 -c 100 -R 2000 http://localhost:8081/db`

|| command | startup | max cpu% | max rss (MB) | Req/sec | Avg | Max |
|---|---|---|---|---|---|---|---|
|JVM First Run | make javaQuarkus| 1.348s | 78.22% | 269 | 1989.96 | 1.63ms | 7.29ms |
|JVM Second Run | - | - | 17% | 287 | 2000.15 | 1.64ms | 9.67ms |
|JVM Third Run | - | - | 14% | 270 | 2000.17 | 1.48ms | 9.73ms |
|GraalVM| make graalvm | 0.019s| 15% | 120 | 2000.25 | 1.78ms | 8.03ms |
|Go| make goService | 0.016s | 15.58% | 21.9 | 2000.28 | 1.51ms | 5.61ms |
|Vertx First Run| make vertx | ? | 24.08% | 234 | 2000.28 | 1.29ms | 8.99ms |
|Vertx Second Run| - | - | 8.06% | 237 | 2000.40 | 1.58ms | 8.67ms |
|Vertx Third Run| - | - | 8% | 230 | 2000.40 | 1.36ms | 4.89ms |